@model Pedido

@{
    ViewData["Title"] = "Finalizando Pedido";
}

<div class="container my-5">
    <div class="p-5 bg-dark text-light rounded-4 shadow-lg border border-warning-subtle gold-glow">

        <!-- Título -->
        <div class="text-center mb-4">
            <h2 class="fw-bold text-warning display-6">
                <i class="bi bi-bag-check-fill me-2"></i>Finalize seu Pedido
            </h2>
            <p class="text-secondary mb-0">Você está a um passo de completar o seu pedido</p>
            <hr class="border-warning opacity-50 w-25 mx-auto mt-3" />
        </div>

        <form asp-action="Checkout" method="post" role="form">
            <input type="hidden" asp-for="Nome" />
            <input type="hidden" asp-for="Sobrenome" />
            <input type="hidden" asp-for="Telefone" />
            <input type="hidden" asp-for="Email" />

            <div class="row g-4 mt-2">
                <div class="col-md-3">
                    <label asp-for="Cep" class="form-label text-warning fw-semibold"></label>
                    <input asp-for="Cep" id="Cep" class="form-control custom-input" />
                    <span asp-validation-for="Cep" class="text-danger small"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Endereco1" class="form-label text-warning fw-semibold"></label>
                    <input asp-for="Endereco1" id="Endereco1" class="form-control custom-input" />
                    <span asp-validation-for="Endereco1" class="text-danger small"></span>
                </div>

                <div class="col-md-3">
                    <label asp-for="Numero" class="form-label text-warning fw-semibold"></label>
                    <input asp-for="Numero" id="Numero" class="form-control custom-input" />
                    <span asp-validation-for="Numero" class="text-danger small"></span>
                </div>
            </div>

            <div class="row g-4 mt-1">
                <div class="col-md-8">
                    <label asp-for="Cidade" class="form-label text-warning fw-semibold"></label>
                    <input asp-for="Cidade" id="Cidade" class="form-control custom-input" />
                </div>

                <div class="col-md-4">
                    <label asp-for="Estado" class="form-label text-warning fw-semibold"></label>
                    <input asp-for="Estado" id="Estado" class="form-control custom-input" />
                </div>
            </div>

            <div class="d-flex justify-content-end gap-3 mt-5">
                <a asp-controller="CarrinhoCompra"
                   asp-action="Index"
                   class="btn btn-outline-warning btn-lg fw-semibold rounded-pill shadow-sm px-4">
                    <i class="bi bi-arrow-left-circle me-2"></i> Voltar ao Carrinho
                </a>

                <button type="submit"
                        class="btn btn-warning btn-lg fw-semibold rounded-pill shadow-sm px-4 text-dark">
                    <i class="bi bi-bag-check-fill me-2"></i> Concluir Pedido
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Overlay de carregamento (inicialmente oculto) -->
<div id="loaderOverlay" class="loader-hidden" aria-hidden="true">
    <div class="spinner-border text-warning" role="status" style="width:4rem;height:4rem;">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<!-- CEP Auto-preenchimento -->
<script>
    (function () {
        const cepInput = document.getElementById("Cep");
        const loader = document.getElementById("loaderOverlay");

        if (!cepInput || !loader) return;

        async function buscarCep(cep) {
            try {
                showLoader();

                const res = await fetch(`/Pedido/BuscarCep?cep=${cep}`);
                const data = await res.json();

                if (data.erro || data.Message) {
                    alert("CEP não encontrado.");
                    return;
                }

                document.getElementById("Endereco1").value = data.logradouro || "";
                document.getElementById("Cidade").value = data.localidade || "";
                document.getElementById("Estado").value = data.uf || "";
            }
            catch (e) {
                alert("Erro ao buscar o CEP.");
            }
            finally {
                hideLoader();
            }
        }

        cepInput.addEventListener("change", function () {
            const cep = this.value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            buscarCep(cep);
        });

        function showLoader() {
            loader.classList.remove('loader-hidden');
            loader.classList.add('loader-visible');
            loader.setAttribute('aria-hidden', 'false');
        }

        function hideLoader() {
            loader.classList.remove('loader-visible');
            loader.classList.add('loader-hidden');
            loader.setAttribute('aria-hidden', 'true');
        }
    })();
</script>

<!-- Estilo personalizado -->
<style>
    .custom-input {
        background: #1b1b1b !important;
        color: #f1f1f1 !important;
        border: 1px solid #7a6029 !important;
        border-radius: 12px;
        padding: 12px 14px;
        transition: 0.3s;
    }

        .custom-input:focus {
            border-color: #d4a63a !important;
            box-shadow: 0 0 10px rgba(212, 166, 58, 0.5) !important;
            background: #222 !important;
        }

    .gold-glow {
        box-shadow: 0 0 18px rgba(255, 193, 7, 0.25) !important;
        border: 1px solid rgba(255, 193, 7, 0.35) !important;
    }

    /* Overlay: fica invisível até o JS mostrar */
    #loaderOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(3px);
        z-index: 9999;
        display: none; /* estado padrão */
        justify-content: center;
        align-items: center;
    }

    .loader-hidden {
        display: none !important;
    }

    .loader-visible {
        display: flex !important;
    }
</style>
